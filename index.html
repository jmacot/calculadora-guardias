<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Guardias</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<meta name="theme-color" content="#1e3a5f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Guardias">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f4f6f9;
    --surface: #ffffff;
    --surface2: #f0f4f8;
    --border: #dde3ec;
    --accent: #1a7f4b;
    --accent2: #1b5fc4;
    --text: #1a2133;
    --muted: #6b7a99;
    --warn: #c0540a;
    --shadow: 0 2px 12px rgba(26,33,51,0.07);
    --shadow-hover: 0 6px 24px rgba(26,33,51,0.12);
  }
  /* Dark mode */
  [data-theme="dark"] {
    --bg: #111827;
    --surface: #1f2937;
    --surface2: #283244;
    --border: #374151;
    --text: #f1f5f9;
    --muted: #94a3b8;
    --warn: #f59e0b;
    --shadow: 0 2px 12px rgba(0,0,0,0.3);
    --shadow-hover: 0 6px 24px rgba(0,0,0,0.4);
  }
  [data-theme="dark"] .result-box.bruto { background: #1e3a5f; border-color: #2563eb; }
  [data-theme="dark"] .result-box.neto { background: #14352a; border-color: #22c55e; }
  [data-theme="dark"] .result-box.irpf-box { background: #3b2a10; border-color: #d97706; }
  [data-theme="dark"] .irpf-row input { background: #3b2a10; border-color: #d97706; color: #f59e0b; }
  [data-theme="dark"] .rates-box { background: #283244; border-color: #374151; }
  [data-theme="dark"] .rate-item input { background: var(--surface); border-color: var(--border); color: var(--text); }
  [data-theme="dark"] .cal-day:hover:not(.empty) { background: var(--surface2); border-color: var(--border); }
  [data-theme="dark"] .cal-day.sel-17 { background: #1e3a5f; border-color: #3b82f6; }
  [data-theme="dark"] .cal-day.sel-17 .cal-day-inner { color: #93c5fd; }
  [data-theme="dark"] .cal-day.sel-17 .cal-day-inner::after { color: #93c5fd; }
  [data-theme="dark"] .cal-day.sel-24 { background: #14352a; border-color: #22c55e; }
  [data-theme="dark"] .cal-day.sel-24 .cal-day-inner { color: #86efac; }
  [data-theme="dark"] .cal-day.sel-24 .cal-day-inner::after { color: #86efac; }
  [data-theme="dark"] .input-group input { background: var(--surface2); border-color: var(--border); color: var(--text); }
  [data-theme="dark"] .input-group input:focus { background: var(--surface); }
  [data-theme="dark"] .tag { background: #1e3a5f; color: #93c5fd; }
  [data-theme="dark"] .tag.green { background: #14352a; color: #86efac; }
  [data-theme="dark"] .tag.amber { background: #3b2a10; color: #fbbf24; }
  [data-theme="dark"] .config-pill.active { background: var(--accent2); border-color: var(--accent2); }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    padding: 2.5rem 1rem 5rem;
  }
  header { text-align: center; margin-bottom: 2.5rem; }
  header h1 {
    font-family: 'Lora', serif;
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    letter-spacing: -0.02em;
    color: var(--text);
  }
  header p { color: var(--muted); margin-top: 0.5rem; font-size: 0.95rem; }
  header { position: relative; }

  .back-home {
    position: absolute;
    top: 0.3rem;
    left: 0.3rem;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: 'DM Mono', 'SF Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.05em;
    color: var(--muted);
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1.5px solid var(--border);
    background: var(--surface2);
    transition: border-color 0.2s, color 0.2s;
  }
  .back-home:hover { border-color: var(--accent); color: var(--accent); }
  @media (max-width: 600px) {
    header { padding-top: 2.8rem; }
    .back-home { top: 0.5rem; left: 0.5rem; padding: 5px 10px; font-size: 10px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 1rem; top: 0.5rem; right: 0.5rem; }
  }

  /* Dark mode toggle */
  .theme-toggle {
    position: absolute;
    top: 0.3rem;
    right: 0.3rem;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 50%;
    width: 42px;
    height: 42px;
    font-size: 1.3rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .theme-toggle:hover { border-color: var(--accent2); box-shadow: var(--shadow-hover); }

  /* Config pills */
  .config-pills {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 1.2rem;
    flex-wrap: wrap;
  }
  .config-pill {
    font-family: 'Inter', sans-serif;
    font-size: 0.68rem;
    font-weight: 600;
    padding: 0.22rem 0.7rem;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .config-pill:hover { border-color: var(--accent2); color: var(--accent2); }
  .config-pill.active { border-color: var(--accent2); color: #fff; background: var(--accent2); }

  /* Reset link under calendar */
  .cal-reset-link {
    display: block;
    text-align: center;
    margin-top: 0.6rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 6px 18px;
    font-family: 'Inter', sans-serif;
    transition: all 0.15s;
    letter-spacing: 0.02em;
  }
  .cal-reset-link:hover { color: #dc2626; border-color: #dc2626; background: #fee2e2; }
  [data-theme="dark"] .cal-reset-link:hover { background: #3b1010; }

  /* Animated value transition */
  .value-animate {
    transition: transform 0.3s cubic-bezier(.4,0,.2,1), opacity 0.3s;
  }
  .value-animate.bumping {
    transform: scale(1.08);
  }
  .container { max-width: 900px; margin: 0 auto; display: grid; gap: 1.4rem; }

  /* CARD */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.8rem;
    box-shadow: var(--shadow);
    transition: box-shadow 0.25s, border-color 0.25s;
  }
  .card:hover { box-shadow: var(--shadow-hover); border-color: #c4cfe0; }
  .card-title {
    font-family: 'Lora', serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.3rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
  }
  .tag {
    font-family: 'Inter', sans-serif;
    font-size: 0.68rem;
    font-weight: 600;
    padding: 0.18rem 0.55rem;
    border-radius: 20px;
    background: #dbeafe;
    color: var(--accent2);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .tag.green { background: #dcfce7; color: var(--accent); }
  .tag.amber { background: #fef3c7; color: var(--warn); }
  /* LAYOUT CARD: calendario + inputs lado a lado */
  .card-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
  }
  @media(max-width: 768px) {
    .card-body { grid-template-columns: 1fr; }
  }
  @media(min-width: 769px) {
    .cal-day-inner { font-size: 1.05rem; }
    .cal-day.sel-17 .cal-day-inner::after,
    .cal-day.sel-24 .cal-day-inner::after { font-size: 0.62rem; }
    .cal-dow { font-size: 0.85rem; }
  }

  /* Grafico de barras */
  .chart-wrap {
    margin-top: 1.8rem;
    padding-top: 1.4rem;
    border-top: 1px solid rgba(255,255,255,0.15);
  }
  .chart-title {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.55);
    margin-bottom: 1rem;
  }
  .bar-row {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    margin-bottom: 0.65rem;
  }
  .bar-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(255,255,255,0.8);
    width: 52px;
    flex-shrink: 0;
    text-align: right;
  }
  .bar-track {
    flex: 1;
    height: 22px;
    background: rgba(255,255,255,0.08);
    border-radius: 6px;
    overflow: hidden;
    display: flex;
  }
  .bar-neto {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    border-radius: 6px 0 0 6px;
    transition: width 0.5s cubic-bezier(.4,0,.2,1);
    min-width: 0;
  }
  .bar-irpf {
    height: 100%;
    background: linear-gradient(90deg, #f97316, #ea580c);
    border-radius: 0 6px 6px 0;
    transition: width 0.5s cubic-bezier(.4,0,.2,1);
    min-width: 0;
  }
  .bar-amount {
    font-size: 0.72rem;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    width: 62px;
    flex-shrink: 0;
    text-align: left;
  }
  .chart-legend {
    display: flex;
    gap: 1.2rem;
    margin-top: 0.9rem;
    justify-content: center;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.7rem;
    color: rgba(255,255,255,0.6);
  }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .legend-dot.neto { background: #22c55e; }
  .legend-dot.irpf { background: #f97316; }

  .bar-section-label {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.45);
    margin-bottom: 0.3rem;
    margin-top: 0.2rem;
    border-left: 2px solid rgba(255,255,255,0.2);
    padding-left: 0.5rem;
  }
  .bar-label.bar-sub {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.6);
  }

  /* Recuadro tarifas editable */
  .rates-box {
    background: #f8fafc;
    border: 1px dashed #c4cfe0;
    border-radius: 10px;
    padding: 0.7rem 1rem;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 1.2rem;
    flex-wrap: wrap;
  }
  .rates-box-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    white-space: nowrap;
  }
  .rate-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.78rem;
    color: var(--muted);
  }
  .rate-item input {
    width: 68px;
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    padding: 0.3rem 0.5rem;
    font-size: 0.85rem;
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    color: var(--text);
    outline: none;
    text-align: center;
    transition: border-color 0.2s;
  }
  .rate-item input:focus {
    border-color: var(--accent2);
    box-shadow: 0 0 0 2px rgba(27,95,196,0.08);
  }
  .rate-unit {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 400;
  }

  /* CALENDARIO */
  .cal-wrap { }
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.8rem;
  }
  .cal-header button {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 30px; height: 30px;
    cursor: pointer;
    font-size: 1rem;
    color: var(--text);
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s;
  }
  .cal-header button:hover { background: var(--border); }
  .cal-month {
    font-family: 'Lora', serif;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
    text-align: center;
    flex: 1;
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 3px;
    width: 100%;
  }
  .cal-dow {
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
    text-align: center;
    padding: 4px 0;
  }
  .cal-dow.weekend { color: #e05a2b; }
  .cal-day {
    position: relative;
    width: 100%;
    padding-top: 100%;
    border-radius: 7px;
    border: 1.5px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
    background: transparent;
  }
  .cal-day-inner {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 0.78rem;
    font-weight: 500;
    color: var(--text);
  }
  .cal-day:hover:not(.empty) { background: var(--surface2); border-color: var(--border); }
  .cal-day.empty { cursor: default; pointer-events: none; }
  .cal-day.weekend .cal-day-inner { color: #c0540a; }
  .cal-day.festivo .cal-day-inner { color: #9333ea; }

  /* Seleccionado 17h */
  .cal-day.sel-17 {
    background: #dbeafe;
    border-color: #3b82f6;
  }
  .cal-day.sel-17 .cal-day-inner {
    color: #1b5fc4;
    font-weight: 700;
  }
  .cal-day.sel-17 .cal-day-inner::after {
    content: '17h';
    font-size: 0.5rem;
    font-weight: 700;
    color: #1b5fc4;
    line-height: 1;
    margin-top: 1px;
  }
  /* Seleccionado 24h */
  .cal-day.sel-24 {
    background: #f0fdf4;
    border-color: #22c55e;
  }
  .cal-day.sel-24 .cal-day-inner {
    color: #1a7f4b;
    font-weight: 700;
  }
  .cal-day.sel-24 .cal-day-inner::after {
    content: '24h';
    font-size: 0.5rem;
    font-weight: 700;
    color: #1a7f4b;
    line-height: 1;
    margin-top: 1px;
  }
  /* Override labels para m√≥dulos con slotLabels (L-V / S-D) */
  .card[data-slot17] .cal-day.sel-17 .cal-day-inner::after { content: attr(data-sel-label); }
  .card[data-slot17] .cal-day.sel-24 .cal-day-inner::after { content: attr(data-sel-label); }

  .cal-legend {
    display: flex;
    gap: 1rem;
    margin-top: 0.7rem;
    flex-wrap: wrap;
  }
  .cal-legend-item {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.72rem;
    color: var(--muted);
  }
  .cal-legend-dot {
    width: 10px; height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
  }

  /* INPUTS LADO DERECHO */
  .inputs-side { display: flex; flex-direction: column; gap: 1rem; }
  .input-group label {
    display: block;
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.4rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }
  .input-group input {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 0.65rem 0.9rem;
    color: var(--text);
    font-size: 1.1rem;
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-group input:focus {
    border-color: var(--accent2);
    box-shadow: 0 0 0 3px rgba(27,95,196,0.1);
    background: #fff;
  }
  .input-group input[type=number]::-webkit-inner-spin-button { opacity: 0.4; }

  .irpf-row {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .irpf-row label {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    white-space: nowrap;
  }
  .irpf-row input {
    width: 80px;
    background: #fff7ed;
    border: 1.5px solid #fcd9b0;
    border-radius: 10px;
    padding: 0.5rem 0.7rem;
    color: var(--warn);
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    outline: none;
    text-align: center;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .irpf-row input:focus { border-color: var(--warn); box-shadow: 0 0 0 3px rgba(192,84,10,0.1); }
  .irpf-hint { font-size: 0.78rem; color: var(--muted); }

  /* RESULTADOS */
  .results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.8rem;
    margin-top: 1.2rem;
  }
  @media(max-width:600px) { .results-grid { grid-template-columns: 1fr; } }
  .result-box {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.1rem;
    text-align: center;
  }
  .result-box .label {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: var(--muted);
    font-weight: 600;
    margin-bottom: 0.45rem;
  }
  .result-box .value {
    font-family: 'Lora', serif;
    font-size: 1.5rem;
    letter-spacing: -0.02em;
    color: var(--text);
  }
  .result-box.bruto { background: #eff6ff; border-color: #bfdbfe; }
  .result-box.bruto .value { color: var(--accent2); }
  .result-box.neto { background: #f0fdf4; border-color: #bbf7d0; }
  .result-box.neto .value { color: var(--accent); }
  .result-box.irpf-box { background: #fff7ed; border-color: #fcd9b0; }
  .result-box.irpf-box .value { color: var(--warn); }

  /* TOTAL FINAL */
  .final-card {
    background: linear-gradient(135deg, #1b4fa0 0%, #1a3a7a 100%);
    border: none;
    border-radius: 16px;
    padding: 2.2rem;
    text-align: center;
    box-shadow: 0 8px 32px rgba(27,79,160,0.25);
  }
  .final-card h2 {
    font-family: 'Lora', serif;
    font-size: 1rem;
    color: rgba(255,255,255,0.65);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 1.6rem;
    font-weight: 600;
  }
  .final-amounts { display: flex; justify-content: center; gap: 3rem; flex-wrap: wrap; }
  .final-item .flabel {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.6);
    margin-bottom: 0.4rem;
    font-weight: 600;
  }
  .final-item .famount {
    font-family: 'Lora', serif;
    font-size: 2.6rem;
    letter-spacing: -0.03em;
    line-height: 1;
    color: #ffffff;
  }
  .final-item.neto .famount { color: #6ee7a0; }
  .separator { width: 1px; background: rgba(255,255,255,0.2); align-self: stretch; }
  .breakdown { margin-top: 1.8rem; display: grid; gap: 0.3rem; }
  .breakdown-group {
    margin-top: 0.5rem;
    font-weight: 700 !important;
    font-size: 0.8rem !important;
    color: rgba(255,255,255,0.9) !important;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 0.2rem;
  }
  .breakdown-group span { font-weight: 700 !important; }
  .breakdown-sub span:first-child {
    color: rgba(255,255,255,0.6) !important;
    font-size: 0.78rem;
    padding-left: 0.3rem;
  }
  .breakdown-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.87rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.55);
  }
  .breakdown-row:last-child { border-bottom: none; }
  .breakdown-row span:last-child { color: rgba(255,255,255,0.9); font-weight: 600; }

  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }

  .app-footer { text-align: center; padding: 16px 0; margin-top: 1rem; }
  .app-footer span { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.03em; }
</style>
</head>
<body>

<header>
  <a class="back-home" href="https://jmacot.github.io/" title="Volver al inicio">‚Üê Inicio</a>
  <button class="theme-toggle" id="btn-theme" title="Cambiar tema"></button>
  <h1>Calculadora de Guardias</h1>
  <p>Selecciona los dias en el calendario para calcular tu retribucion mensual</p>
  <div class="config-pills" id="config-pills"></div>
</header>

<div class="container">
  <div id="modules-container"></div>
  <div class="final-card" id="final-card"></div>
</div>

<div class="app-footer"><span>COT ‚Äî Calculadora de Guardias v2.0</span></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FORMATO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = n => n.toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç¨';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONFIGURACIONES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CONFIGS = {
  hsjd: {
    label: 'HSJD',
    modules: [
      { id: 'gpf', name: 'Guardias de Presencia Fisica', type: 'presencial', tag: 'Presenciales', tagColor: '', logo: 'hsjd', rates: { r17: 21.31, r24: 20.01 }, labels: { c17: 'Guardias de 17 horas', c24: 'Guardias de 24 horas' } },
      { id: 'hsjd', name: 'HSJD Localizadas', type: 'compuesta', tag: 'Localizados', tagColor: 'amber', logo: 'hsjd', rates: { m17: 8.5, e17: 21.31, m24: 12, e24: 20.01 }, labels: { c17: 'Localizadas de 17 horas', c24: 'Localizadas de 24 horas' } }
    ]
  },
  hsjd_vithas: {
    label: 'HSJD + VITHAS',
    modules: [
      { id: 'gpf', name: 'Guardias de Presencia Fisica', type: 'presencial', tag: 'Presenciales', tagColor: '', logo: 'hsjd', rates: { r17: 21.31, r24: 20.01 }, labels: { c17: 'Guardias de 17 horas', c24: 'Guardias de 24 horas' } },
      { id: 'hsjd', name: 'HSJD Localizadas', type: 'compuesta', tag: 'Localizados', tagColor: 'amber', logo: 'hsjd', rates: { m17: 8.5, e17: 21.31, m24: 12, e24: 20.01 }, labels: { c17: 'Localizadas de 17 horas', c24: 'Localizadas de 24 horas' } },
      { id: 'loc', name: 'Vithas Localizadas', type: 'plana', tag: 'Localizados', tagColor: 'green', logo: 'vithas', rates: { r17: 250, r24: 300 }, labels: { c17: 'Localizadas L-V', c24: 'Localizadas S-D y festivos' }, slotLabels: { s17: 'L-V', s24: 'S-D' } }
    ]
  },
  vithas: {
    label: 'VITHAS',
    modules: [
      { id: 'loc', name: 'Vithas Localizadas', type: 'plana', tag: 'Localizados', tagColor: 'green', logo: 'vithas', rates: { r17: 250, r24: 300 }, labels: { c17: 'Localizadas L-V', c24: 'Localizadas S-D y festivos' }, slotLabels: { s17: 'L-V', s24: 'S-D' } }
    ]
  },
  sas: {
    label: 'SAS',
    modules: [
      { id: 'sas_pf', name: 'Guardias Presencia Fisica', type: 'presencial', tag: 'Presenciales', tagColor: '', logo: 'sas', rates: { r17: 0, r24: 0 }, labels: { c17: 'Guardias de 17 horas', c24: 'Guardias de 24 horas' } },
      { id: 'sas_loc', name: 'SAS Localizadas', type: 'compuesta', tag: 'Localizados', tagColor: 'amber', logo: 'sas', rates: { m17: 0, e17: 0, m24: 0, e24: 0 }, labels: { c17: 'Localizadas de 17 horas', c24: 'Localizadas de 24 horas' } }
    ]
  },
  sas_privada: {
    label: 'SAS + PRIVADA',
    modules: [
      { id: 'sas_pf', name: 'Guardias Presencia Fisica', type: 'presencial', tag: 'Presenciales', tagColor: '', logo: 'sas', rates: { r17: 0, r24: 0 }, labels: { c17: 'Guardias de 17 horas', c24: 'Guardias de 24 horas' } },
      { id: 'sas_loc', name: 'SAS Localizadas', type: 'compuesta', tag: 'Localizados', tagColor: 'amber', logo: 'sas', rates: { m17: 0, e17: 0, m24: 0, e24: 0 }, labels: { c17: 'Localizadas de 17 horas', c24: 'Localizadas de 24 horas' } },
      { id: 'priv', name: 'Privada Localizadas', type: 'plana', tag: 'Localizados', tagColor: 'green', logo: null, rates: { r17: 0, r24: 0 }, labels: { c17: 'Localizadas L-V', c24: 'Localizadas S-D y festivos' }, slotLabels: { s17: 'L-V', s24: 'S-D' } }
    ]
  }
};

const LOGOS = {
  hsjd: { dia: 'imagenes/hsjd-dia.jpg', noche: 'imagenes/hsjd-noche.png' },
  vithas: { dia: 'imagenes/vithas-dia.jpg', noche: 'imagenes/vithas-noche.png' },
  sas: { dia: 'imagenes/sas-dia.png', noche: 'imagenes/sas-noche.png' }
};

let currentConfig = 'hsjd_vithas';
let calState = {};

// ‚ïê‚ïê‚ïê FESTIVOS NACIONALES FIJOS ‚ïê‚ïê‚ïê
const FESTIVOS_FIJOS = [
  [1,1],[1,6],[5,1],[8,15],[10,12],[11,1],[12,6],[12,8],[12,25]
];

function pascua(y) {
  const a=y%19, b=Math.floor(y/100), c=y%100;
  const d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25);
  const g=Math.floor((b-f+1)/3), h=(19*a+b-d-g+15)%30;
  const i=Math.floor(c/4), k=c%4;
  const l=(32+2*e+2*i-h-k)%7;
  const m=Math.floor((a+11*h+22*l)/451);
  const mes=Math.floor((h+l-7*m+114)/31);
  const dia=((h+l-7*m+114)%31)+1;
  return {mes, dia};
}

function viernesSanto(y) {
  const p = pascua(y);
  const d = new Date(y, p.mes-1, p.dia);
  d.setDate(d.getDate()-2);
  return `${y}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function festivosNacionales(y) {
  const set = new Set();
  FESTIVOS_FIJOS.forEach(([m,d]) => {
    set.add(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
  });
  set.add(viernesSanto(y));
  return set;
}

// ‚ïê‚ïê‚ïê FESTIVOS AUTONOMICOS ‚ïê‚ïê‚ïê
const FESTIVOS_CCAA = {
  'andalucia':       { fijos: [[2,28]], pascua: ['jueves_santo'] },
  'aragon':          { fijos: [[4,23]], pascua: ['jueves_santo'] },
  'asturias':        { fijos: [[9,8]],  pascua: ['jueves_santo'] },
  'baleares':        { fijos: [[3,1]],  pascua: ['jueves_santo'] },
  'canarias':        { fijos: [[5,30]], pascua: ['jueves_santo'] },
  'cantabria':       { fijos: [[7,28]], pascua: ['jueves_santo'] },
  'castilla-la-mancha': { fijos: [[5,31]], pascua: ['jueves_santo','corpus'] },
  'castilla-y-leon': { fijos: [[4,23]], pascua: ['jueves_santo'] },
  'cataluna':        { fijos: [[6,24],[9,11]], pascua: ['lunes_pascua'] },
  'extremadura':     { fijos: [[9,8]],  pascua: ['jueves_santo'] },
  'galicia':         { fijos: [[7,25]], pascua: ['jueves_santo'] },
  'madrid':          { fijos: [[5,2]],  pascua: ['jueves_santo'] },
  'murcia':          { fijos: [[6,9]],  pascua: ['jueves_santo'] },
  'navarra':         { fijos: [[12,3]], pascua: ['jueves_santo'] },
  'pais-vasco':      { fijos: [[10,25]], pascua: ['jueves_santo'] },
  'la-rioja':        { fijos: [[6,9]],  pascua: ['jueves_santo','lunes_pascua'] },
  'comunidad-valenciana': { fijos: [[10,9]], pascua: ['lunes_pascua'] },
  'ceuta':           { fijos: [[9,2]],  pascua: ['jueves_santo'] },
  'melilla':         { fijos: [[9,17]], pascua: ['jueves_santo'] },
};

function festivosCCAA(y, ccaa) {
  const set = new Set();
  const cfg = FESTIVOS_CCAA[ccaa];
  if (!cfg) return set;
  cfg.fijos.forEach(([m,d]) => {
    set.add(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
  });
  const p = pascua(y);
  const pd = new Date(y, p.mes-1, p.dia);
  (cfg.pascua || []).forEach(tipo => {
    const d = new Date(pd);
    if (tipo === 'jueves_santo') d.setDate(d.getDate()-3);
    else if (tipo === 'lunes_pascua') d.setDate(d.getDate()+1);
    else if (tipo === 'corpus') d.setDate(d.getDate()+60);
    set.add(`${y}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
  });
  return set;
}

const festivosCache = {};
function getFestivos(y) {
  if (!festivosCache[y]) {
    const nac = festivosNacionales(y);
    festivosCCAA(y, 'andalucia').forEach(f => nac.add(f));
    festivosCache[y] = nac;
  }
  return festivosCache[y];
}

function esFestivo(y, m, d) {
  const s = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  return getFestivos(y).has(s);
}

function es24h(y, m, d) {
  const dow = new Date(y, m, d).getDay();
  return dow === 0 || dow === 6 || esFestivo(y, m, d);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CALENDARIO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio',
               'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS_DOW = ['L','M','X','J','V','S','D'];

function renderCal(id) {
  const state = calState[id];
  if (!state) return;
  const {year, month, selected} = state;
  const mod = CONFIGS[currentConfig].modules.find(m => m.id === id);
  const sl = mod && mod.slotLabels;
  const label = document.getElementById(`${id}-month-label`);
  const grid  = document.getElementById(`${id}-cal`);
  if (!label || !grid) return;

  label.textContent = `${MESES[month]} ${year}`;
  grid.innerHTML = '';

  DIAS_DOW.forEach((d, i) => {
    const el = document.createElement('div');
    el.className = 'cal-dow' + (i >= 5 ? ' weekend' : '');
    el.textContent = d;
    grid.appendChild(el);
  });

  const firstDow = (new Date(year, month, 1).getDay() + 6) % 7;
  for (let i = 0; i < firstDow; i++) {
    const el = document.createElement('div');
    el.className = 'cal-day empty';
    el.innerHTML = '<div class="cal-day-inner"></div>';
    grid.appendChild(el);
  }

  const daysInMonth = new Date(year, month+1, 0).getDate();
  for (let d = 1; d <= daysInMonth; d++) {
    const el = document.createElement('div');
    const key = `${year}-${month}-${d}`;
    const tipo = es24h(year, month, d) ? '24' : '17';
    const festivo = esFestivo(year, month, d);
    const dow = (new Date(year, month, d).getDay() + 6) % 7;

    let cls = 'cal-day';
    if (festivo) cls += ' festivo';
    else if (dow >= 5) cls += ' weekend';
    if (selected[key]) cls += ` sel-${tipo}`;
    el.className = cls;

    const inner = document.createElement('div');
    inner.className = 'cal-day-inner';
    inner.textContent = d;
    if (sl) inner.setAttribute('data-sel-label', tipo === '17' ? sl.s17 : sl.s24);
    el.appendChild(inner);

    el.addEventListener('click', () => {
      if (selected[key]) { delete selected[key]; }
      else { selected[key] = tipo; }
      syncInputs(id);
      renderCal(id);
      calcular();
    });

    grid.appendChild(el);
  }
}

function renderAllCals() {
  const cfg = CONFIGS[currentConfig];
  cfg.modules.forEach(m => renderCal(m.id));
}

function syncInputs(id) {
  const state = calState[id];
  if (!state) return;
  let c17 = 0, c24 = 0;
  Object.values(state.selected).forEach(t => { if(t==='17') c17++; else c24++; });
  const el17 = document.getElementById(`${id}-count17`);
  const el24 = document.getElementById(`${id}-count24`);
  if (el17) el17.value = c17;
  if (el24) el24.value = c24;
}

// ‚ïê‚ïê‚ïê NAVEGACION CALENDARIOS (con sync) ‚ïê‚ïê‚ïê
function navCal(sourceId, dir) {
  let newMonth = calState[sourceId].month + dir;
  let newYear = calState[sourceId].year;
  if (newMonth < 0) { newMonth = 11; newYear--; }
  if (newMonth > 11) { newMonth = 0; newYear++; }
  const cfg = CONFIGS[currentConfig];
  cfg.modules.forEach(m => {
    if (calState[m.id]) {
      calState[m.id].month = newMonth;
      calState[m.id].year = newYear;
      renderCal(m.id);
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GENERAR MODULOS DINAMICAMENTE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getModuleHTML(mod) {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  let logoHTML = '';
  if (mod.logo && LOGOS[mod.logo]) {
    const src = isDark ? LOGOS[mod.logo].noche : LOGOS[mod.logo].dia;
    logoHTML = `<img class="mod-logo" data-logo="${mod.logo}" src="${src}" style="height:34px;max-width:115px;width:auto;object-fit:contain;vertical-align:middle;">`;
  }
  const tagClass = mod.tagColor ? `tag ${mod.tagColor}` : 'tag';

  let ratesHTML = '';
  if (mod.type === 'presencial') {
    const v17 = mod.rates.r17 || '';
    const v24 = mod.rates.r24 || '';
    ratesHTML = `
      <div class="rates-box">
        <span class="rates-box-label">Tarifas</span>
        <div class="rate-item">
          <span>17h</span>
          <input type="number" id="${mod.id}-rate17" value="${v17}" step="0.01" min="0" placeholder="0">
          <span class="rate-unit">‚Ç¨/h</span>
        </div>
        <div class="rate-item">
          <span>24h</span>
          <input type="number" id="${mod.id}-rate24" value="${v24}" step="0.01" min="0" placeholder="0">
          <span class="rate-unit">‚Ç¨/h</span>
        </div>
      </div>`;
  } else if (mod.type === 'compuesta') {
    const m17 = mod.rates.m17 || '';
    const e17 = mod.rates.e17 || '';
    const m24 = mod.rates.m24 || '';
    const e24 = mod.rates.e24 || '';
    ratesHTML = `
      <div class="rates-box">
        <span class="rates-box-label">Tarifas</span>
        <div class="rate-item">
          <span>17h</span>
          <input type="number" id="${mod.id}-mult17" value="${m17}" step="0.5" min="0" placeholder="h" style="width:50px">
          <span class="rate-unit">h x</span>
          <input type="number" id="${mod.id}-eur17" value="${e17}" step="0.01" min="0" placeholder="0">
          <span class="rate-unit">‚Ç¨/h</span>
        </div>
        <div class="rate-item">
          <span>24h</span>
          <input type="number" id="${mod.id}-mult24" value="${m24}" step="0.5" min="0" placeholder="h" style="width:50px">
          <span class="rate-unit">h x</span>
          <input type="number" id="${mod.id}-eur24" value="${e24}" step="0.01" min="0" placeholder="0">
          <span class="rate-unit">‚Ç¨/h</span>
        </div>
      </div>`;
  } else if (mod.type === 'plana') {
    const v17 = mod.rates.r17 || '';
    const v24 = mod.rates.r24 || '';
    const lb17 = mod.slotLabels ? mod.slotLabels.s17 : '17h';
    const lb24 = mod.slotLabels ? mod.slotLabels.s24 : '24h';
    ratesHTML = `
      <div class="rates-box">
        <span class="rates-box-label">Tarifas</span>
        <div class="rate-item">
          <span>${lb17}</span>
          <input type="number" id="${mod.id}-rate17" value="${v17}" step="1" min="0" placeholder="0">
          <span class="rate-unit">‚Ç¨</span>
        </div>
        <div class="rate-item">
          <span>${lb24}</span>
          <input type="number" id="${mod.id}-rate24" value="${v24}" step="1" min="0" placeholder="0">
          <span class="rate-unit">‚Ç¨</span>
        </div>
      </div>`;
  }

  const slotAttr = mod.slotLabels ? ` data-slot17="${mod.slotLabels.s17}" data-slot24="${mod.slotLabels.s24}"` : '';
  return `
    <div class="card" data-module="${mod.id}"${slotAttr}>
      <div class="card-title">
        ${logoHTML}
        ${mod.name}
        <span class="${tagClass}">${mod.tag}</span>
      </div>
      ${ratesHTML}
      <div class="card-body">
        <div class="cal-wrap">
          <div class="cal-header">
            <button id="${mod.id}-prev">&#8249;</button>
            <div class="cal-month" id="${mod.id}-month-label"></div>
            <button id="${mod.id}-next">&#8250;</button>
          </div>
          <div class="cal-grid" id="${mod.id}-cal"></div>
          <button class="cal-reset-link" data-cal="${mod.id}">limpiar</button>
        </div>
        <div class="inputs-side">
          <div class="input-group">
            <label>${mod.labels.c17}</label>
            <input type="number" id="${mod.id}-count17" min="0" value="0" placeholder="0">
          </div>
          <div class="input-group">
            <label>${mod.labels.c24}</label>
            <input type="number" id="${mod.id}-count24" min="0" value="0" placeholder="0">
          </div>
          <div class="irpf-row">
            <label>IRPF (%)</label>
            <input type="number" id="${mod.id}-irpf" min="0" max="50" step="0.5" value="15">
            <span class="irpf-hint">Retencion fiscal</span>
          </div>
        </div>
      </div>
      <div class="results-grid">
        <div class="result-box"><div class="label">Base bruta ${mod.slotLabels ? mod.slotLabels.s17 : '17h'}</div><div class="value" id="${mod.id}-res17">0,00 ‚Ç¨</div></div>
        <div class="result-box"><div class="label">Base bruta ${mod.slotLabels ? mod.slotLabels.s24 : '24h'}</div><div class="value" id="${mod.id}-res24">0,00 ‚Ç¨</div></div>
        <div class="result-box bruto"><div class="label">Total bruto</div><div class="value" id="${mod.id}-bruto">0,00 ‚Ç¨</div></div>
        <div class="result-box irpf-box"><div class="label">IRPF retenido</div><div class="value" id="${mod.id}-irpf-val">0,00 ‚Ç¨</div></div>
        <div class="result-box neto"><div class="label">Total neto</div><div class="value" id="${mod.id}-neto">0,00 ‚Ç¨</div></div>
      </div>
    </div>`;
}

function renderFinalCard() {
  const cfg = CONFIGS[currentConfig];
  const mods = cfg.modules;

  // Agrupar modulos por hospital para el breakdown
  const groups = {};
  mods.forEach(m => {
    const groupName = m.logo ? (m.logo === 'hsjd' ? 'HSJD' : 'VITHAS') : m.name.split(' ')[0].toUpperCase();
    if (!groups[groupName]) groups[groupName] = [];
    groups[groupName].push(m);
  });

  let breakdownHTML = '';
  for (const [groupName, groupMods] of Object.entries(groups)) {
    if (Object.keys(groups).length > 1 || groupMods.length > 1) {
      breakdownHTML += `<div class="breakdown-row breakdown-group"><span>${groupName}</span></div>`;
    }
    groupMods.forEach(m => {
      const subLabel = m.type === 'presencial' ? 'Presenciales' : 'Localizadas';
      const prefix = (Object.keys(groups).length > 1 || groupMods.length > 1) ? '  ' : '';
      const cls = (Object.keys(groups).length > 1 || groupMods.length > 1) ? 'breakdown-row breakdown-sub' : 'breakdown-row';
      breakdownHTML += `<div class="${cls}"><span>${prefix}${subLabel}</span><span id="bk-${m.id}-neto">0,00 ‚Ç¨</span></div>`;
    });
  }
  breakdownHTML += `<div class="breakdown-row" style="margin-top:0.5rem"><span>IRPF total retenido</span><span id="bk-irpf-total" style="color:#fbbf24">0,00 ‚Ç¨</span></div>`;

  // Barras de desglose
  let barsHTML = '';
  for (const [groupName, groupMods] of Object.entries(groups)) {
    barsHTML += `<div class="bar-section-label"${Object.keys(groups).indexOf(groupName) > 0 ? ' style="margin-top:0.6rem"' : ''}>${groupName}</div>`;
    groupMods.forEach(m => {
      const barLabel = m.type === 'presencial' ? 'Presencial' : 'Localiz.';
      barsHTML += `
        <div class="bar-row">
          <div class="bar-label bar-sub">${barLabel}</div>
          <div class="bar-track">
            <div class="bar-neto" id="bar-${m.id}-neto" style="width:0%"></div>
            <div class="bar-irpf" id="bar-${m.id}-irpf" style="width:0%"></div>
          </div>
          <div class="bar-amount" id="bar-${m.id}-amt">0,00 ‚Ç¨</div>
        </div>`;
    });
  }

  document.getElementById('final-card').innerHTML = `
    <h2>Resumen Total del Mes</h2>
    <div class="final-amounts">
      <div class="final-item bruto">
        <div class="flabel">Total Bruto</div>
        <div class="famount" id="totalBruto">0,00 ‚Ç¨</div>
      </div>
      <div class="separator"></div>
      <div class="final-item neto">
        <div class="flabel">Total Neto</div>
        <div class="famount" id="totalNeto">0,00 ‚Ç¨</div>
      </div>
    </div>
    <div class="breakdown" style="max-width:400px;margin:0 auto">
      ${breakdownHTML}
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Desglose por modulo</div>
      ${barsHTML}
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot neto"></div>Neto</div>
        <div class="legend-item"><div class="legend-dot irpf"></div>IRPF</div>
      </div>
    </div>`;
}

function renderModules(configKey) {
  currentConfig = configKey;
  const cfg = CONFIGS[configKey];
  const container = document.getElementById('modules-container');

  // Guardar mes/anio actual si existe
  let savedYear = new Date().getFullYear();
  let savedMonth = new Date().getMonth();
  const anyState = Object.values(calState)[0];
  if (anyState) {
    savedYear = anyState.year;
    savedMonth = anyState.month;
  }

  // Reset calState
  calState = {};
  cfg.modules.forEach(m => {
    calState[m.id] = {
      year: savedYear,
      month: savedMonth,
      selected: {}
    };
  });

  // Generar HTML de modulos
  container.innerHTML = cfg.modules.map(m => getModuleHTML(m)).join('');

  // Generar final card
  renderFinalCard();

  // Restaurar tarifas del usuario desde localStorage
  restoreUserRates(configKey);

  // Renderizar calendarios
  renderAllCals();

  // Anadir event listeners
  cfg.modules.forEach(m => {
    document.getElementById(`${m.id}-prev`).addEventListener('click', () => navCal(m.id, -1));
    document.getElementById(`${m.id}-next`).addEventListener('click', () => navCal(m.id, 1));
  });

  document.querySelectorAll('.cal-reset-link').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.cal;
      if (calState[id]) {
        calState[id].selected = {};
        syncInputs(id);
        renderCal(id);
        calcular();
      }
    });
  });

  // Input listeners
  container.querySelectorAll('input').forEach(el => el.addEventListener('input', () => {
    calcular();
    saveUserRates(configKey);
  }));

  // Actualizar pills activa
  document.querySelectorAll('.config-pill').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.config === configKey);
  });

  calcular();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CALCULOS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animateValue(el, newText) {
  if (!el || el.textContent === newText) return;
  el.textContent = newText;
  el.classList.add('value-animate', 'bumping');
  setTimeout(() => el.classList.remove('bumping'), 300);
}

function calcular() {
  const cfg = CONFIGS[currentConfig];
  let totalBruto = 0, totalNeto = 0, totalIRPF = 0;
  const modResults = [];

  cfg.modules.forEach(mod => {
    const c17 = parseFloat(document.getElementById(`${mod.id}-count17`)?.value) || 0;
    const c24 = parseFloat(document.getElementById(`${mod.id}-count24`)?.value) || 0;
    const irpf = parseFloat(document.getElementById(`${mod.id}-irpf`)?.value) || 0;

    let base17 = 0, base24 = 0;

    if (mod.type === 'presencial') {
      const r17 = parseFloat(document.getElementById(`${mod.id}-rate17`)?.value) || 0;
      const r24 = parseFloat(document.getElementById(`${mod.id}-rate24`)?.value) || 0;
      base17 = c17 * r17 * 17;
      base24 = c24 * r24 * 24;
    } else if (mod.type === 'compuesta') {
      const m17 = parseFloat(document.getElementById(`${mod.id}-mult17`)?.value) || 0;
      const e17 = parseFloat(document.getElementById(`${mod.id}-eur17`)?.value) || 0;
      const m24 = parseFloat(document.getElementById(`${mod.id}-mult24`)?.value) || 0;
      const e24 = parseFloat(document.getElementById(`${mod.id}-eur24`)?.value) || 0;
      base17 = c17 * m17 * e17;
      base24 = c24 * m24 * e24;
    } else if (mod.type === 'plana') {
      const r17 = parseFloat(document.getElementById(`${mod.id}-rate17`)?.value) || 0;
      const r24 = parseFloat(document.getElementById(`${mod.id}-rate24`)?.value) || 0;
      base17 = c17 * r17;
      base24 = c24 * r24;
    }

    const bruto = base17 + base24;
    const neto = bruto * ((100 - irpf) / 100);
    const irpfAmt = bruto - neto;

    animateValue(document.getElementById(`${mod.id}-res17`), fmt(base17));
    animateValue(document.getElementById(`${mod.id}-res24`), fmt(base24));
    animateValue(document.getElementById(`${mod.id}-bruto`), fmt(bruto));
    animateValue(document.getElementById(`${mod.id}-neto`), fmt(neto));
    animateValue(document.getElementById(`${mod.id}-irpf-val`), fmt(irpfAmt));

    totalBruto += bruto;
    totalNeto += neto;
    totalIRPF += irpfAmt;

    modResults.push({ id: mod.id, bruto, neto, irpfAmt });
  });

  animateValue(document.getElementById('totalBruto'), fmt(totalBruto));
  animateValue(document.getElementById('totalNeto'), fmt(totalNeto));

  // Breakdown
  modResults.forEach(r => {
    animateValue(document.getElementById(`bk-${r.id}-neto`), fmt(r.neto));
  });
  animateValue(document.getElementById('bk-irpf-total'), fmt(totalIRPF));

  // Barras
  const maxBruto = Math.max(...modResults.map(r => r.bruto), 1);
  function setPct(id, pct) {
    const el = document.getElementById(id);
    if (el) el.style.width = Math.max(0, Math.min(100, pct)).toFixed(1) + '%';
  }
  modResults.forEach(r => {
    setPct(`bar-${r.id}-neto`, (r.neto / maxBruto) * 100);
    setPct(`bar-${r.id}-irpf`, (r.irpfAmt / maxBruto) * 100);
    const amtEl = document.getElementById(`bar-${r.id}-amt`);
    if (amtEl) amtEl.textContent = fmt(r.bruto);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PERSISTENCIA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveUserRates(configKey) {
  const cfg = CONFIGS[configKey];
  const data = {};
  cfg.modules.forEach(mod => {
    const modRates = {};
    const inputs = document.querySelectorAll(`[data-module="${mod.id}"] .rates-box input, [data-module="${mod.id}"] .irpf-row input`);
    inputs.forEach(inp => { modRates[inp.id] = inp.value; });
    data[mod.id] = modRates;
  });
  localStorage.setItem(`guardias-rates-${configKey}`, JSON.stringify(data));
  localStorage.setItem(`guardias-rates-${configKey}-date`, new Date().toDateString());
}

function restoreUserRates(configKey) {
  const saved = localStorage.getItem(`guardias-rates-${configKey}`);
  const savedDate = localStorage.getItem(`guardias-rates-${configKey}-date`);
  if (saved && savedDate === new Date().toDateString()) {
    try {
      const data = JSON.parse(saved);
      for (const [modId, rates] of Object.entries(data)) {
        for (const [inputId, value] of Object.entries(rates)) {
          const el = document.getElementById(inputId);
          if (el) el.value = value;
        }
      }
    } catch(e) { /* ignore */ }
  }
}

function saveConfig(configKey) {
  localStorage.setItem('guardias-config', configKey);
  localStorage.setItem('guardias-config-date', new Date().toDateString());
}

function loadConfig() {
  const saved = localStorage.getItem('guardias-config');
  const savedDate = localStorage.getItem('guardias-config-date');
  if (saved && savedDate === new Date().toDateString() && CONFIGS[saved]) {
    return saved;
  }
  return 'hsjd_vithas';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DARK MODE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const btnTheme = document.getElementById('btn-theme');

function applyTheme(dark) {
  if (dark) {
    document.documentElement.setAttribute('data-theme', 'dark');
    btnTheme.textContent = '‚òÄÔ∏è';
  } else {
    document.documentElement.removeAttribute('data-theme');
    btnTheme.textContent = 'üåô';
  }
  // Cambiar logos dia/noche
  document.querySelectorAll('.mod-logo').forEach(img => {
    const key = img.dataset.logo;
    if (key && LOGOS[key]) {
      img.src = dark ? LOGOS[key].noche : LOGOS[key].dia;
    }
  });
}

function getAutoTheme() {
  const hour = new Date().getHours();
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  return (hour >= 21 || hour < 7 || prefersDark) ? 'dark' : 'light';
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  const savedDate = localStorage.getItem('theme-date');
  const today = new Date().toDateString();
  if (saved && savedDate === today) {
    applyTheme(saved === 'dark');
  } else {
    localStorage.removeItem('theme');
    localStorage.removeItem('theme-date');
    applyTheme(getAutoTheme() === 'dark');
  }
}

btnTheme.addEventListener('click', () => {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  applyTheme(!isDark);
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
  localStorage.setItem('theme-date', new Date().toDateString());
});

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  const saved = localStorage.getItem('theme');
  const savedDate = localStorage.getItem('theme-date');
  const today = new Date().toDateString();
  if (!saved || savedDate !== today) {
    applyTheme(getAutoTheme() === 'dark');
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initTheme();

// Renderizar pills de configuracion
const pillsContainer = document.getElementById('config-pills');
Object.entries(CONFIGS).forEach(([key, cfg]) => {
  const btn = document.createElement('button');
  btn.className = 'config-pill';
  btn.dataset.config = key;
  btn.textContent = cfg.label;
  btn.addEventListener('click', () => {
    renderModules(key);
    saveConfig(key);
  });
  pillsContainer.appendChild(btn);
});

// Cargar configuracion guardada o por defecto
const initialConfig = loadConfig();
renderModules(initialConfig);
saveConfig(initialConfig);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  URL PARAMS (for integration with planning-cot)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const params = new URLSearchParams(window.location.search);
  if (!params.has('tab')) return;
  const tab = params.get('tab');
  if (tab && CONFIGS[tab]) {
    renderModules(tab);
    saveConfig(tab);
  }
  const fills = [['gpf17','gpf-count17'],['gpf24','gpf-count24'],['hsjd17','hsjd-count17'],['hsjd24','hsjd-count24']];
  for (const [p, id] of fills) {
    const v = params.get(p);
    if (v) { const el = document.getElementById(id); if (el) { el.value = parseInt(v, 10) || 0; } }
  }
  calcular();
  if (window.history.replaceState) window.history.replaceState({}, '', window.location.pathname);
})();
</script>
</body>
</html>
